<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RideSphere | Infinite Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap');
        :root { --neon-blue: #00f2ff; --bg-dark: #05070a; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0; }
        .font-game { font-family: 'Orbitron', sans-serif; }
        
        #game-stage {
            position: relative;
            background: radial-gradient(circle at bottom left, #0f172a 0%, #020617 100%);
            border-radius: 24px;
            height: 400px;
            border: 1px solid #1e293b;
            overflow: hidden;
            width: 100%;
        }

        .multiplier-text {
            font-size: clamp(3.5rem, 12vw, 6.5rem);
            font-weight: 900;
            text-shadow: 0 0 30px rgba(0, 242, 255, 0.6);
        }

        .road {
            position: absolute;
            bottom: 15%;
            width: 200%;
            height: 4px;
            background: repeating-linear-gradient(90deg, #334155 0, #334155 30px, transparent 30px, transparent 60px);
            display: none;
        }

        @keyframes drive { from { transform: translateX(0); } to { transform: translateX(-60px); } }
        .animate-road { display: block; animation: drive 0.4s linear infinite; }

        .car-sprite { filter: drop-shadow(0 0 15px var(--neon-blue)); transition: transform 0.1s linear; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        .btn-ready { background: #00f2ff; color: #000; box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }
        .btn-cashout { background: linear-gradient(to right, #ff9d00, #ff5e00); color: #fff; box-shadow: 0 0 20px rgba(255, 157, 0, 0.5); }
        .btn-locked { background: #1e293b; color: #475569; cursor: not-allowed; }
        .btn-waiting { background: #0ea5e9; color: white; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-4xl w-full space-y-6">
        <div class="flex justify-between items-center px-2">
            <h1 class="text-2xl font-game text-cyan-400 italic tracking-tighter">RIDESPHERE</h1>
            <div class="glass px-6 py-2 rounded-2xl border-cyan-500/30 border">
                <span class="text-[10px] text-slate-500 font-bold uppercase mr-2">Balance</span>
                <span id="balance-display" class="text-xl font-bold text-white">$1,000.00</span>
            </div>
        </div>

        <div id="game-stage">
            <div class="absolute inset-0 flex flex-col items-center justify-center z-50">
                <div id="multi-val" class="multiplier-text font-game text-cyan-400">0.00x</div>
                <div id="crash-label" class="text-red-500 font-bold tracking-[0.5em] uppercase hidden">Crashed!</div>
                <div id="timer-label" class="text-cyan-400 font-bold uppercase hidden">Next Round in <span id="timer-sec">5</span>s</div>
            </div>

            <div id="car-wrapper" class="absolute left-10 bottom-[15%] z-40 car-sprite">
                <svg width="100" height="50" viewBox="0 0 24 24" class="fill-cyan-400">
                    <path d="M18.92 11c-.13-1.05-.63-1.95-1.42-2.55L15 5H9L6.5 8.45C5.7 9.05 5.2 9.95 5.08 11H18.92M19 13H5c-1.1 0-2 .9-2 2v5c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-5c0-1.1-.9-2-2-2M7 18c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1m10 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1Z"/>
                </svg>
            </div>
            <div class="road" id="road-anim"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass p-4 rounded-3xl md:col-span-1">
                <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Stake</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="bet-input" value="10.00" class="bg-transparent text-2xl font-bold w-full outline-none text-white">
                    <button onclick="quickBet(2)" class="text-[10px] bg-slate-800 p-2 rounded">2x</button>
                </div>
            </div>
            <button id="action-btn" onclick="handleMainAction()" class="btn-ready rounded-3xl md:col-span-2 text-2xl font-black italic uppercase transition-all duration-300">Place Bet</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDe8i7FOSmuWCUhqwLXb9nBDWQKSIBKJpw",
            authDomain: "ridesphere-popkid.firebaseapp.com",
            projectId: "ridesphere-popkid",
            storageBucket: "ridesphere-popkid.firebasestorage.app",
            messagingSenderId: "476462103607",
            appId: "1:476462103607:web:27ec5a2134d5954ac113b2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let balance = parseFloat(localStorage.getItem('rs_balance')) || 1000.00;
        let activeBet = 0;
        let hasBet = false;
        let hasCashedOut = false;
        let gameState = 'WAITING';
        let currentMulti = 0.00;

        const balanceDisplay = document.getElementById('balance-display');
        const multiDisplay = document.getElementById('multi-val');
        const btn = document.getElementById('action-btn');
        const car = document.getElementById('car-wrapper');
        const road = document.getElementById('road-anim');
        const crashLabel = document.getElementById('crash-label');
        const timerLabel = document.getElementById('timer-label');
        const timerSec = document.getElementById('timer-sec');

        function updateBalanceUI(amount) {
            balance = amount;
            balanceDisplay.innerText = `$${balance.toFixed(2)}`;
            localStorage.setItem('rs_balance', balance.toFixed(2));
        }

        updateBalanceUI(balance);

        // --- THE INFINITE LOOP ENGINE ---
        async function runRound() {
            // 1. STARTING THE RACE
            gameState = 'RACING';
            let multi = 1.00;
            const crashAt = (Math.random() * 5.5 + 1.05).toFixed(2);
            
            const ticker = setInterval(async () => {
                if (multi >= crashAt) {
                    clearInterval(ticker);
                    gameState = 'CRASHED';
                    await setDoc(doc(db, "game", "live"), { state: 'CRASHED', val: multi });
                    
                    // Show crash for 3 seconds, then start countdown
                    setTimeout(startCountdown, 3000);
                } else {
                    multi += 0.01 * (multi < 2 ? 1.1 : multi / 1.1);
                    await setDoc(doc(db, "game", "live"), { state: 'RACING', val: multi });
                }
            }, 60);
        }

        async function startCountdown() {
            gameState = 'WAITING';
            let count = 5;
            
            // Clean local bet states for the new round
            hasBet = false;
            hasCashedOut = false;
            activeBet = 0;

            const timer = setInterval(async () => {
                if (count <= 0) {
                    clearInterval(timer);
                    runRound(); // Auto-start next round
                } else {
                    await setDoc(doc(db, "game", "live"), { state: 'WAITING', val: count });
                    count--;
                }
            }, 1000);
        }

        // --- UI SYNC (The Fix) ---
        onSnapshot(doc(db, "game", "live"), (snap) => {
            const data = snap.data();
            if(!data) return;
            currentMulti = data.val;

            if (data.state === 'WAITING') {
                // Global UI Reset
                multiDisplay.classList.add('hidden');
                crashLabel.classList.add('hidden');
                timerLabel.classList.remove('hidden');
                timerSec.innerText = Math.floor(data.val);
                road.classList.remove('animate-road');
                car.style.transform = `translate(0, 0)`;

                // Button Reset (if user hasn't bet yet)
                if (!hasBet) {
                    btn.innerText = "Place Bet";
                    btn.className = "btn-ready rounded-3xl md:col-span-2 text-2xl font-black italic uppercase";
                }
            } 
            else if (data.state === 'RACING') {
                multiDisplay.classList.remove('hidden');
                timerLabel.classList.add('hidden');
                multiDisplay.innerText = data.val.toFixed(2) + "x";
                multiDisplay.className = "multiplier-text font-game text-white";
                road.classList.add('animate-road');
                
                const y = (data.val - 1) * 60;
                const x = (data.val - 1) * 15;
                car.style.transform = `translate(${x}px, -${y}px)`;

                if (hasBet && !hasCashedOut) {
                    btn.innerText = `CASH OUT $${(activeBet * data.val).toFixed(2)}`;
                    btn.className = "btn-cashout rounded-3xl md:col-span-2 text-2xl font-black italic uppercase";
                }
            } 
            else if (data.state === 'CRASHED') {
                multiDisplay.innerText = data.val.toFixed(2) + "x";
                multiDisplay.className = "multiplier-text font-game text-red-500";
                crashLabel.classList.remove('hidden');
                road.classList.remove('animate-road');

                if (hasBet && !hasCashedOut) {
                    btn.innerText = "BUSTED";
                    btn.className = "btn-locked rounded-3xl md:col-span-2 text-2xl font-black italic uppercase";
                }
            }
        });

        window.handleMainAction = async () => {
            const betInput = document.getElementById('bet-input');
            const betVal = parseFloat(betInput.value);

            // Check if game is in WAITING (Betting) phase
            const snap = await getDoc(doc(db, "game", "live"));
            const serverState = snap.data()?.state;

            if (serverState === 'WAITING' && !hasBet) {
                if (betVal > balance || betVal <= 0) return alert("Check Balance");
                
                activeBet = betVal;
                updateBalanceUI(balance - activeBet);
                hasBet = true;
                
                btn.innerText = "BET PLACED";
                btn.className = "btn-waiting rounded-3xl md:col-span-2 text-2xl font-black italic uppercase";
            } 
            else if (serverState === 'RACING' && hasBet && !hasCashedOut) {
                const profit = activeBet * currentMulti;
                updateBalanceUI(balance + profit);
                hasCashedOut = true;
                
                btn.innerText = `WIN! +$${(profit - activeBet).toFixed(2)}`;
                btn.className = "btn-locked rounded-3xl md:col-span-2 text-2xl font-black italic uppercase";
            }
        };

        window.quickBet = (mult) => {
            const input = document.getElementById('bet-input');
            input.value = (parseFloat(input.value) * mult).toFixed(2);
        };

        // Initialize first loop if nothing is running
        setTimeout(async () => {
           const snap = await getDoc(doc(db, "game", "live"));
           if(!snap.exists() || snap.data().state === 'CRASHED') {
               startCountdown();
           }
        }, 1000);

    </script>
</body>
</html>
