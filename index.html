<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIDESPHERE | LIVE CRASH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700&display=swap');
        body { background: #020617; color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        .neon-font { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-text { color: #22d3ee; text-shadow: 0 0 15px rgba(34, 211, 238, 0.6); }
        #game-area { 
            background: radial-gradient(circle at bottom left, #1e293b 0%, #020617 100%); 
            background-size: 40px 40px; 
            background-image: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px); 
        }
        .car-sprite { transition: transform 60ms linear; filter: drop-shadow(0 0 15px #22d3ee); }
        .crashed-anim { animation: explode 0.2s forwards; }
        @keyframes explode {
            0% { transform: scale(1); filter: brightness(2); }
            100% { transform: scale(1.2) rotate(5deg); filter: brightness(1) grayscale(1) opacity(0.5); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="auth-ui" class="glass p-10 rounded-[3rem] w-full max-w-sm text-center shadow-2xl">
        <h1 class="neon-font neon-text text-3xl font-black italic mb-1">RIDESPHERE</h1>
        <div class="space-y-4 mt-8">
            <input type="email" id="email" placeholder="Email" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <input type="password" id="pass" placeholder="Password" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <button onclick="handleAuth('login')" class="bg-cyan-600 w-full p-4 rounded-2xl font-black uppercase">Login</button>
            <button onclick="handleAuth('signup')" class="w-full text-[10px] text-slate-500 uppercase font-bold mt-2 tracking-widest">Join & Get 100 Free Coins</button>
        </div>
    </div>

    <div id="admin-ui" class="hidden w-full max-w-4xl mb-6">
        <div class="glass p-6 rounded-[2.5rem] border-red-500/40">
            <h2 class="neon-font text-red-500 mb-4 text-sm">ADMIN CONTROL (GOD MODE)</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">Set Next Crash (e.g., 1.50)</p>
                    <div class="flex gap-2">
                        <input type="number" id="admin-crash-set" step="0.01" value="2.00" class="flex-1 bg-black p-3 rounded-xl border border-red-500/30 text-red-500 font-bold">
                        <button onclick="lockCrash()" class="bg-red-600 px-6 py-2 rounded-xl font-bold text-xs">LOCK RIG</button>
                    </div>
                </div>
                <div id="admin-user-list" class="space-y-2 max-h-[100px] overflow-y-auto"></div>
            </div>
            <button onclick="toggleAdminView()" class="mt-4 w-full text-[10px] text-slate-500 font-bold">BACK TO GAME</button>
        </div>
    </div>

    <div id="game-ui" class="hidden w-full max-w-4xl space-y-4">
        <div class="flex justify-between items-center glass p-5 rounded-3xl">
            <div>
                <p id="role-tag" class="text-[9px] text-slate-500 font-bold uppercase">Verified Driver</p>
                <h2 id="p-name" class="neon-font text-cyan-400">...</h2>
            </div>
            <div class="text-right">
                <p class="text-[9px] text-slate-500 font-bold uppercase">Current Balance</p>
                <h2 id="p-balance" class="text-green-400 font-black text-2xl">Ksh 0</h2>
            </div>
        </div>

        <div id="game-area" class="relative w-full h-[380px] rounded-[3rem] border border-white/5 flex items-center justify-center overflow-hidden">
            <div id="mult-display" class="neon-font text-8xl italic font-black text-white z-10 select-none">1.00x</div>
            
            <div id="car" class="car-sprite absolute bottom-10 left-10 w-32">
                <svg viewBox="0 0 100 50" fill="none"><path d="M10 30L20 15H70L90 30H10Z" fill="#22d3ee"/><rect x="15" y="30" width="70" height="10" fill="#0891b2"/><circle cx="25" cy="40" r="7" fill="#020617" stroke="#22d3ee"/></svg>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
            <div class="glass p-6 rounded-[2.5rem]">
                <p class="text-[10px] text-slate-500 font-bold mb-2 uppercase text-center">Stake Amount (Ksh)</p>
                <div class="flex items-center gap-4 mb-4">
                    <button onclick="adjustStake(-10)" class="bg-slate-800 w-12 h-12 rounded-full font-bold">-</button>
                    <input type="number" id="stake-amt" value="10" class="flex-1 bg-transparent text-center text-4xl font-black outline-none">
                    <button onclick="adjustStake(10)" class="bg-slate-800 w-12 h-12 rounded-full font-bold">+</button>
                </div>
                <button id="bet-btn" onclick="togglePlay()" class="w-full py-6 rounded-3xl bg-green-500 text-black font-black text-2xl uppercase transition-all shadow-lg active:scale-95">Bet</button>
            </div>
            
            <div class="glass p-6 rounded-[2.5rem] flex flex-col justify-around">
                <button onclick="alert('M-PESA: Send to Admin')" class="text-cyan-400 font-bold text-sm uppercase tracking-widest">Deposit</button>
                <button id="admin-access-btn" onclick="toggleAdminView()" class="hidden text-red-500 font-bold text-[10px] uppercase">Open Admin Rig</button>
                <button onclick="logout()" class="text-slate-600 text-[10px] font-bold uppercase">Log Out</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDe8i7FOSmuWCUhqwLXb9nBDWQKSIBKJpw",
            authDomain: "ridesphere-popkid.firebaseapp.com",
            projectId: "ridesphere-popkid",
            storageBucket: "ridesphere-popkid.firebasestorage.app",
            messagingSenderId: "476462103607",
            appId: "1:476462103607:web:27ec5a2134d5954ac113b2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "iantaracha@gmail.com";

        let currentBalance = 0, mult = 1.0, isPlaying = false, hasCashed = false, gameLoop, stake = 0;

        window.handleAuth = async (type) => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            try {
                if (type === 'signup') {
                    const c = await createUserWithEmailAndPassword(auth, e, p);
                    await setDoc(doc(db, "drivers", c.user.uid), { username: e.split('@')[0], balance: 100 });
                } else { await signInWithEmailAndPassword(auth, e, p); }
            } catch (err) { alert(err.message); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-access-btn').classList.remove('hidden');
                    document.getElementById('role-tag').innerText = "System Admin";
                    document.getElementById('role-tag').classList.add('text-red-500');
                }
                onSnapshot(doc(db, "drivers", user.uid), (s) => {
                    if (s.exists()) {
                        currentBalance = s.data().balance;
                        document.getElementById('p-name').innerText = s.data().username;
                        document.getElementById('p-balance').innerText = "Ksh " + currentBalance.toLocaleString();
                    }
                });
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
                document.getElementById('game-ui').classList.add('hidden');
            }
        });

        window.adjustStake = (v) => {
            let s = document.getElementById('stake-amt');
            s.value = Math.max(1, parseInt(s.value) + v);
        };

        window.lockCrash = async () => {
            const val = parseFloat(document.getElementById('admin-crash-set').value);
            await setDoc(doc(db, "settings", "engine"), { nextCrash: val });
            alert("Rigged at " + val + "x");
        };

        window.togglePlay = async () => {
            if (isPlaying) { cashOut(); return; }
            
            stake = parseInt(document.getElementById('stake-amt').value);
            if (stake > currentBalance) return alert("Low Balance!");

            // DEDUCT BALANCE IMMEDIATELY
            await updateDoc(doc(db, "drivers", auth.currentUser.uid), { balance: increment(-stake) });
            
            startLiveGame();
        };

        async function startLiveGame() {
            isPlaying = true; hasCashed = false; mult = 1.0;
            const btn = document.getElementById('bet-btn');
            const car = document.getElementById('car');
            const disp = document.getElementById('mult-display');
            
            btn.innerText = "CASH OUT";
            btn.className = "w-full py-6 rounded-3xl bg-orange-500 text-white font-black text-2xl uppercase";
            car.classList.remove('crashed-anim');

            // GET RIGGED DATA
            const rigDoc = await getDoc(doc(db, "settings", "engine"));
            const crashPoint = rigDoc.exists() ? rigDoc.data().nextCrash : (Math.random() * 4 + 1.1).toFixed(2);

            let startTime = Date.now();

            gameLoop = setInterval(() => {
                let elapsed = (Date.now() - startTime) / 1000;
                // AVIATOR GROWTH FORMULA: Multiplier grows faster over time
                mult = Math.pow(1.08, elapsed * 2);
                
                disp.innerText = mult.toFixed(2) + "x";
                
                // Live Movement
                let x = (mult - 1) * 70;
                let y = (mult - 1) * 35;
                car.style.transform = `translate(${x}px, -${y}px)`;

                if (mult >= crashPoint) {
                    crash();
                }
            }, 50);
        }

        function crash() {
            clearInterval(gameLoop);
            isPlaying = false;
            document.getElementById('car').classList.add('crashed-anim');
            document.getElementById('mult-display').classList.add('text-red-500');
            const btn = document.getElementById('bet-btn');
            btn.innerText = "FLEW AWAY!";
            btn.className = "w-full py-6 rounded-3xl bg-slate-800 text-slate-500 font-black text-2xl uppercase";

            setTimeout(() => {
                document.getElementById('mult-display').classList.remove('text-red-500');
                document.getElementById('mult-display').innerText = "1.00x";
                document.getElementById('car').style.transform = "translate(0,0)";
                btn.innerText = "BET";
                btn.className = "w-full py-6 rounded-3xl bg-green-500 text-black font-black text-2xl uppercase";
            }, 3000);
        }

        async function cashOut() {
            if (hasCashed || !isPlaying) return;
            hasCashed = true;
            
            const win = Math.floor(stake * mult);
            await updateDoc(doc(db, "drivers", auth.currentUser.uid), { balance: increment(win) });
            
            const btn = document.getElementById('bet-btn');
            btn.innerText = "WIN Ksh " + win;
            btn.className = "w-full py-6 rounded-3xl bg-blue-600 text-white font-black text-2xl uppercase shadow-[0_0_20px_rgba(37,99,235,0.6)]";
        }

        window.toggleAdminView = () => document.getElementById('admin-ui').classList.toggle('hidden');
        window.logout = () => signOut(auth);
    </script>
</body>
</html>
