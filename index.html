<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIDESPHERE | CRASH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Inter:wght@400;700&display=swap');
        body { background: #020617; color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        .neon-font { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-text { color: #22d3ee; text-shadow: 0 0 15px rgba(34, 211, 238, 0.8); }
        
        /* The Multiplier Graph Area */
        #game-canvas {
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px), 
                              linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px);
        }

        .car-sprite {
            transition: transform 0.1s linear;
            filter: drop-shadow(0 0 10px #22d3ee);
        }

        @keyframes crash-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(3px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -1px) rotate(0deg); }
        }
        .crashed { animation: crash-shake 0.1s infinite; filter: grayscale(1) blur(1px); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <div id="auth-ui" class="glass p-10 rounded-[3rem] w-full max-w-sm text-center shadow-2xl border-t border-cyan-500/30">
        <h1 class="neon-font neon-text text-3xl font-black italic mb-1">RIDESPHERE</h1>
        <div id="signup-form" class="space-y-4 mt-6">
            <input type="text" id="reg-username" placeholder="Username" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <input type="email" id="reg-email" placeholder="Gmail Address" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <input type="password" id="reg-password" placeholder="Password" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <button onclick="signUp()" class="bg-cyan-600 w-full p-4 rounded-2xl font-black">CREATE ACCOUNT</button>
            <p class="text-[10px] text-slate-500">Already a driver? <span class="text-cyan-400 cursor-pointer" onclick="toggleAuth()">Login</span></p>
        </div>
        <div id="login-form" class="hidden space-y-4 mt-6">
            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <input type="password" id="login-password" placeholder="Password" class="w-full p-4 rounded-2xl bg-slate-900 border border-slate-800 outline-none">
            <button onclick="login()" class="bg-cyan-600 w-full p-4 rounded-2xl font-black">SIGN IN</button>
            <p class="text-[10px] text-slate-500">New driver? <span class="text-cyan-400 cursor-pointer" onclick="toggleAuth()">Sign Up</span></p>
        </div>
    </div>

    <div id="garage-ui" class="hidden w-full max-w-4xl p-4 space-y-4">
        
        <div class="flex justify-between items-center glass p-4 rounded-3xl">
            <div>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Player</p>
                <h1 id="user-display" class="neon-font text-xl neon-text tracking-tighter">POPKID</h1>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-500 font-bold">BALANCE</p>
                <p id="balance-display" class="text-green-400 font-black text-2xl">Ksh 0</p>
            </div>
        </div>

        <div id="game-canvas" class="relative w-full h-[400px] rounded-[2.5rem] border border-white/10 overflow-hidden flex items-center justify-center">
            
            <div id="multiplier-display" class="neon-font text-7xl italic font-black text-white z-10 transition-all">1.00x</div>
            
            <div id="car-container" class="car-sprite absolute bottom-10 left-10 w-32">
                <svg viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 30L20 15H70L90 30H10Z" fill="#22d3ee"/>
                    <rect x="15" y="30" width="70" height="10" fill="#0891b2"/>
                    <circle cx="25" cy="40" r="7" fill="#020617" stroke="#22d3ee" stroke-width="2"/>
                    <circle cx="75" cy="40" r="7" fill="#020617" stroke="#22d3ee" stroke-width="2"/>
                </svg>
            </div>

            <div id="game-status" class="absolute top-10 text-cyan-400 font-bold tracking-[0.5em] uppercase hidden">Waiting for next round...</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass p-6 rounded-[2rem] flex flex-col items-center justify-center space-y-4">
                <div class="flex items-center space-x-4">
                    <button onclick="adjustBet(-50)" class="bg-slate-800 p-3 rounded-full font-bold w-12">-</button>
                    <input type="number" id="bet-amount" value="100" class="bg-transparent text-center text-2xl font-black w-24 outline-none">
                    <button onclick="adjustBet(50)" class="bg-slate-800 p-3 rounded-full font-bold w-12">+</button>
                </div>
                <button id="action-btn" onclick="placeBet()" class="w-full py-6 rounded-3xl bg-green-500 text-black font-black text-2xl shadow-lg hover:scale-95 transition-all uppercase">Bet</button>
            </div>
            
            <div class="glass p-6 rounded-[2rem] flex flex-col justify-between">
                <div class="flex justify-around mb-4">
                    <button onclick="openTab('deposit')" class="text-cyan-400 font-bold">DEPOSIT</button>
                    <button onclick="openTab('withdraw')" class="text-slate-500 font-bold">WITHDRAW</button>
                </div>
                <div class="text-[10px] text-slate-500 uppercase tracking-widest text-center">
                    Latest Crashes: <span class="text-red-400">1.2x, 4.5x, 1.0x</span>
                </div>
                <button onclick="logout()" class="mt-4 text-[10px] text-slate-600 font-bold uppercase">Sign Out</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut, reload } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // CONFIG (Same as yours)
        const firebaseConfig = {
            apiKey: "AIzaSyDe8i7FOSmuWCUhqwLXb9nBDWQKSIBKJpw",
            authDomain: "ridesphere-popkid.firebaseapp.com",
            projectId: "ridesphere-popkid",
            storageBucket: "ridesphere-popkid.firebasestorage.app",
            messagingSenderId: "476462103607",
            appId: "1:476462103607:web:27ec5a2134d5954ac113b2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // GAME STATE
        let currentBalance = 0;
        let multiplier = 1.00;
        let isRunning = false;
        let currentBet = 0;
        let gameInterval;
        let hasCashedOut = false;

        // AUTH LOGIC
        window.toggleAuth = () => {
            document.getElementById('signup-form').classList.toggle('hidden');
            document.getElementById('login-form').classList.toggle('hidden');
        };

        window.signUp = async () => {
            const user = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await sendEmailVerification(cred.user);
                await setDoc(doc(db, "drivers", cred.user.uid), { username: user, balance: 0 }); // Initial Balance 0
                alert("Verify Gmail then sign in!");
                await signOut(auth);
            } catch (err) { alert(err.message); }
        };

        window.login = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            try {
                const cred = await signInWithEmailAndPassword(auth, email, pass);
                await reload(cred.user);
                if (!cred.user.emailVerified) { alert("Verify Gmail!"); await signOut(auth); }
            } catch (err) { alert(err.message); }
        };

        onAuthStateChanged(auth, async (u) => {
            if (u && u.emailVerified) {
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('garage-ui').classList.remove('hidden');
                onSnapshot(doc(db, "drivers", u.uid), (s) => {
                    if (s.exists()) {
                        currentBalance = s.data().balance;
                        document.getElementById('user-display').innerText = s.data().username;
                        document.getElementById('balance-display').innerText = "Ksh " + currentBalance.toLocaleString();
                    }
                });
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
                document.getElementById('garage-ui').classList.add('hidden');
            }
        });

        // CRASH GAME CORE
        window.adjustBet = (val) => {
            let b = document.getElementById('bet-amount');
            b.value = Math.max(0, parseInt(b.value) + val);
        };

        window.placeBet = async () => {
            const betInput = parseInt(document.getElementById('bet-amount').value);
            if (isRunning) {
                cashOut();
                return;
            }

            if (betInput > currentBalance || betInput <= 0) return alert("Low balance or invalid bet!");

            // Deduct Bet
            currentBet = betInput;
            await updateDoc(doc(db, "drivers", auth.currentUser.uid), { balance: increment(-currentBet) });
            
            startGame();
        };

        function startGame() {
            isRunning = true;
            hasCashedOut = false;
            multiplier = 1.00;
            const btn = document.getElementById('action-btn');
            btn.innerText = "CASH OUT";
            btn.classList.replace('bg-green-500', 'bg-orange-500');
            
            const car = document.getElementById('car-container');
            const multText = document.getElementById('multiplier-display');
            car.classList.remove('crashed');

            // Admin-Style Crash Logic (Random but could be controlled via Firebase)
            let crashPoint = (Math.random() * 5 + 1).toFixed(2); 

            gameInterval = setInterval(() => {
                multiplier += 0.01;
                multText.innerText = multiplier.toFixed(2) + "x";
                
                // Move car based on multiplier
                let xPos = (multiplier - 1) * 50; 
                let yPos = (multiplier - 1) * 20;
                car.style.transform = `translate(${xPos}px, -${yPos}px)`;

                if (multiplier >= crashPoint) {
                    crash();
                }
            }, 50);
        }

        function crash() {
            clearInterval(gameInterval);
            isRunning = false;
            document.getElementById('car-container').classList.add('crashed');
            document.getElementById('multiplier-display').classList.add('text-red-600');
            const btn = document.getElementById('action-btn');
            btn.innerText = "CRASHED!";
            btn.disabled = true;

            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = "BET";
                btn.classList.replace('bg-orange-500', 'bg-green-500');
                document.getElementById('multiplier-display').classList.remove('text-red-600');
                resetCar();
            }, 3000);
        }

        async function cashOut() {
            if (hasCashedOut || !isRunning) return;
            hasCashedOut = true;
            
            let winAmount = Math.floor(currentBet * multiplier);
            await updateDoc(doc(db, "drivers", auth.currentUser.uid), { balance: increment(winAmount) });
            
            const btn = document.getElementById('action-btn');
            btn.innerText = "CASHED +Ksh" + winAmount;
            btn.classList.replace('bg-orange-500', 'bg-blue-500');
        }

        function resetCar() {
            const car = document.getElementById('car-container');
            car.style.transform = `translate(0px, 0px)`;
            document.getElementById('multiplier-display').innerText = "1.00x";
        }

        window.logout = () => signOut(auth);
    </script>
</body>
</html>
